services:
  # -------------------------------------------------------
  # PORT STRATEGY
  # -------------------------------------------------------
  # Gateway:    3000 (Public Entry Point)
  # AuthMS:     3001 (Internal)
  # Platform A: 3002 (Internal - Future)
  # Platform B: 3003 (Internal - Future)
  # -------------------------------------------------------

  # -------------------------------------------------------
  # SERVICIO 1: AUTH SERVICE (Backend NestJS)
  # -------------------------------------------------------
  # -------------------------------------------------------
  # GATEWAY: API GATEWAY (Public Entry Point)
  # -------------------------------------------------------
  api-gateway:
    container_name: Gateway
    build:
      context: ./Services/ApiGateway
      dockerfile: Dockerfile.dev
    volumes:
      - ./Services/ApiGateway:/usr/src/app
      - /usr/src/app/node_modules
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - NATS_SERVERS=nats://nats-server:4222
    command: npm run start:debug
    networks:
      - nexus-dev-network

  # -------------------------------------------------------
  # SERVICIO 1: AUTH SERVICE (Backend NestJS)
  # -------------------------------------------------------
  auth-service:
    container_name: Auth
    build:
      context: ./Services/AuthMS
      dockerfile: Dockerfile.dev
    volumes:
      - ./Services/AuthMS:/usr/src/app
      - /usr/src/app/node_modules
    ports:
      - "3001:3000" # Mapped to 3001 as per strategy
      - "9229:9229"
    environment:
      - DATABASE_URL=postgresql://${AUTH_DB_USER}:${AUTH_DB_PASS}@Auth-DB:5432/${AUTH_DB_NAME}?schema=public
      - JWT_ACCESS_SECRET=${JWT_ACCESS_SECRET}
      - JWT_REFRESH_SECRET=${JWT_REFRESH_SECRET}
      - NATS_SERVERS=nats://nats-server:4222
    command: npm run start:debug
    depends_on:
      auth-db:
        condition: service_healthy
    networks:
      - nexus-dev-network

    #Base de datos
  auth-db:
    image: postgres:17.3-alpine
    container_name: Auth-DB
    environment:
      - POSTGRES_USER=${AUTH_DB_USER}
      - POSTGRES_PASSWORD=${AUTH_DB_PASS}
      - POSTGRES_DB=${AUTH_DB_NAME}
    ports:
      - "${AUTH_DB_PORT}:5432"
    volumes:
      - auth-postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${AUTH_DB_USER} -d ${AUTH_DB_NAME}"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - nexus-dev-network

  # -------------------------------------------------------
  # SERVICIO DE MENSAJER√çA: NATS
  # -------------------------------------------------------
  nats-server:
    image: nats:2.10-alpine
    container_name: Nats-Server
    ports:
      - "4222:4222" # Client port
      - "8222:8222" # HTTP monitoring port
    networks:
      - nexus-dev-network

networks:
  nexus-dev-network:
    driver: bridge
volumes:
  auth-postgres-data:
